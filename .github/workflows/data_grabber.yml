name: Docker on self-hosted runner

on:
  push:
    branches: ["master"]
    paths-ignore: ["**.md"]
  workflow_dispatch:

jobs:
  build:
    name: Build & Run in Docker
    runs-on: self-hosted
    steps:
      - name: Build Docker image
        run: |
          docker build -t datagrabber .
      - name: Create directories for datagrabber
        continue-on-error: true
        run: |
          # Create directories for preserving datagrabber data
          mkdir -p ~/datagrabber/Output
      - name: Set permissions
        continue-on-error: true
        run: |
          # Make datagrabber Output directory writable
          chmod 777 ~/datagrabber/Output
      - name: Checkout
        uses: actions/checkout@v3
      - name: Copy datagrabber data
        run: |
          # Copy datagrabber data
          echo "Copying datagrabber data from $PWD/ to ~/datagrabber"
          cp -r $PWD/* ~/datagrabber/.
      - name: Stop previous container
        continue-on-error: true
        run: |
          # Stop previous container
          docker container stop datagrabber
          docker container rm datagrabber
      - name: Run datagrabber
        run: |
          # Run datagrabber with output directory mounted
          docker run -d \
          -v ~/datagrabber/Output:/app/Output \
          --name datagrabber \
          datagrabber
